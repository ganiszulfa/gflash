
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html
xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US" >
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta http-equiv="Description" content="Simple Games To Improve Your Vocabulary" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>G Flash Cards</title>
	<link rel="stylesheet" href="main.css">
	<style>
		#list option {
			padding: 5px;
			margin-top: 5px;
			margin-bottom: 5px;
		}
		#list {
			width: 100%;

		}


	</style>
	<script type="text/javascript">var runFancy = true;</script>

	<!--[if IE]>
<script type="text/javascript">
    runFancy = false;
</script>
<![endif]-->
	<script type="text/javascript">
		if (!runFancy) {
			alert('Oh noo...!! You are using Internet Explorer. Errors may occur...!! Please use Google Chrome, Apple Safari or Mozilla Firefox.');
		}
	</script>
</head>
<body>
	<script type="text/javascript">
		function setAttributeOnload(object, attribute, val) {
			if (window.addEventListener) {
				window.addEventListener('load',
					function () { object[attribute] = val; }, false);
			} else {
				window.attachEvent('onload', function () { object[attribute] = val; });
			}
		}
	</script>

	<div id="container">
		<!--- todo 1: Load the name and target from the dataset and replace [DATASET NAME] and [Dataset Source] and [Dataset Target] -->
		<h1>[DATASET NAME]</h1>
		<div id="body">
			<p>

			<p>
				<input class="dic_type" checked="checked" type="radio" name="dic_type" value="source2target" /> [Dataset Source] - [Dataset Target]
				<input class="dic_type" type="radio" name="dic_type" value="target2source" /> [Dataset Target] - [Dataset Source]
			</p>
			<hr />
			<p>
				<input class="answer_type" checked="checked" type="radio" name="answer_type" value="option" /> Multiple
				Choice
				(<a href="#" id="write_mul_cho">?</a>)
				<input class="answer_type" type="radio" name="answer_type" value="text" /> Input Answer
			</p>
			<hr />

			Pack:
			<br/>
			<select name="word_set" class="word_set" id="list" multiple size="4">
				<!--- todo 2: Load the packs from the dataset and replace [Dataset Packs] -->
			</select> 
			<br/>
			<a href="#" id="show_words">Show</a> <!-- show the words in the selected pack -->

			</p>

			<!--- todo 3: Load the questions and answers from the dataset and fill the question and answer codes-->
			<code id="question"></code>

			<p>Your answer:</p>
			<div class="answer_text">
				<input id="user_answer" type="text" name="user_answer" />
			</div>
			<div id="answer_choice">
				<table style="width: 100%; margin-left: -10px;">
					<tr style="height: 45px;">
						<td style="min-width: 60px;"><input class="answer_choice choice_a" type="radio" name="answer_choice" value="0" />(1)</td>
						<td><a target="_blank" id="choice_a" title=""></a></td>
						<td><input class="answer_choice choice_a" type="radio" name="answer_choice" value="0" /></td>
					</tr>
					<tr style="height: 45px;">
						<td><input class="answer_choice choice_b" type="radio" name="answer_choice" value="1" />(2)</td>
						<td><a target="_blank" id="choice_b" title=""></a></td>
						<td><input class="answer_choice choice_b" type="radio" name="answer_choice" value="1" /></td>
					</tr>
					<tr style="height: 45px;">
						<td><input class="answer_choice choice_c" type="radio" name="answer_choice" value="2" />(3)</td>
						<td><a target="_blank" id="choice_c" title=""></a></td>
						<td><input class="answer_choice choice_c" type="radio" name="answer_choice" value="2" /></td>
					</tr>

				</table>


			</div>
			<code id="answer"></code>

			<p class="answer_text">
				<a href="#" id="show_answer">Show Answer</a>
				<a href="#" id="check_answer">Check Answer</a>
			</p>
		</div>
		<div id="cont_words" style="display:none">
			<p>Words in the selected pack:</p>
			<ul id="words_list"></ul>
		</div>


		<div id="cont_announcement" style="display:none;font-size: 18px;font-weight: bold;color: red;">
		</div>
		<div id="cont_mul_cho" style="display:none">
			<p>You can also use your 1,2,3 keyboard to select the option. 
			</p>
		</div>
		<div id="cont_about" style="display:none">
			<p>This simple game's purpose is to train your vocabulary skill</p>
			<p>Email to ganiszulfa@gmail.com if you have any feedback</p>
		</div>
		<div id="cont_stat" style="display:none">
			<p><span id="q_cnt"></span> question(s) are given</p>
			<p>your last 20 answers:<br /><span id="form">--------------------</span></p>
			<p>your total form: <span id="form2">0</span>% correct answers</p>
		</div>
		<p class="footer">
			<a href="index.html">BACK TO MENU</a>
			<a id="write_stat" href="#">stat</a>
			<a id="write_about" href="#">about</a>
		</p>
	</div>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
	<script src="main.js"></script>
	<script>
		$(document).ready(function() {
			let currentDataset = null;
			let currentPack = null;
			let currentWords = [];
			let currentQuestionIndex = 0;
			let currentQuestion = null;
			let correctAnswer = null;
			let isSource2Target = true;
			
			// Statistics tracking
			let totalQuestions = 0;
			let correctAnswers = 0;
			let last20Answers = [];
			let shuffleIndexes = [];

			// Get dataset parameter from URL
			function getUrlParameter(name) {
				const urlParams = new URLSearchParams(window.location.search);
				return urlParams.get(name);
			}

			function generateShuffledRange(n) {
				// 1. Generate an array containing numbers from 0 to n-1
				// This satisfies steps 1 and 2 implicitly by creating the initial ordered array.
				if (typeof n !== 'number' || n <= 0 || !Number.isInteger(n)) {
					console.error("Input 'n' must be a positive integer.");
					return [];
				}

				let result = Array.from({ length: n }, (_, i) => i);

				// 3. Put the number in step 1 to step 2 in random order (Shuffling the array)
				// This uses the Fisher-Yates (or Knuth) shuffle algorithm for efficient and uniform randomness.
				for (let i = result.length - 1; i > 0; i--) {
					// Generate a random index j from 0 to i (inclusive)
					const j = Math.floor(Math.random() * (i + 1));

					// Swap elements at i and j
					// [result[i], result[j]] = [result[j], result[i]]; // Modern destructuring swap
					let temp = result[i];
					result[i] = result[j];
					result[j] = temp;
				}

				// 4. The function returns the var in step 3
				return result;
			}

			// Load dataset and initialize the game
			function loadDataset() {
				const datasetParam = getUrlParameter('dataset');
				if (!datasetParam || datasetParam === 'NOTFOUND') {
					alert('No dataset selected. Please go back to the menu and select a dataset.');
					window.location.href = 'index.html';
					return;
				}

				$.getJSON(datasetParam, function(data) {
					currentDataset = data;
					
					// Update page title and labels
					$('h1').text(data.name);
					// Update radio button labels by replacing the text content
					const source2targetRadio = $('input[name="dic_type"][value="source2target"]');
					const target2sourceRadio = $('input[name="dic_type"][value="target2source"]');
					
					// Update the text after each radio button
					source2targetRadio[0].nextSibling.textContent = ' ' + data.source_name + ' - ' + data.target_name;
					target2sourceRadio[0].nextSibling.textContent = ' ' + data.target_name + ' - ' + data.source_name;
					
					// Load packs into dropdown
					const packSelect = $('#list');
					packSelect.empty();
					packSelect.append('<option value="ALL">ALL</option>');
					
					data.packs.forEach(function(pack, index) {
						packSelect.append(`<option value="${index}">${pack.name}</option>`);
					});
				}).fail(function() {
					alert('Error loading dataset. Please check if the file exists.');
					window.location.href = 'index.html';
				});
			}

			// Handle pack selection
			$('#list').change(function() {
				const selectedValues = $(this).val();
				console.log('Packs selected:', selectedValues);
				
				if (selectedValues && selectedValues.length > 0) {
					currentWords = [];
					let packNames = [];
					
					// Check if ALL is selected
					if (selectedValues.includes('ALL')) {
						// Combine all words from all packs
						currentDataset.packs.forEach(function(pack) {
							currentWords = currentWords.concat(pack.words);
							packNames.push(pack.name);
						});
						currentPack = { name: 'ALL', words: currentWords };
					} else {
						// Combine words from selected packs
						selectedValues.forEach(function(packIndex) {
							if (packIndex !== 'ALL') {
								const pack = currentDataset.packs[packIndex];
								if (pack) {
									currentWords = currentWords.concat(pack.words);
									packNames.push(pack.name);
								}
							}
						});
						currentPack = { name: packNames.join(', '), words: currentWords };
					}
					
					console.log('Current pack:', currentPack);
					console.log('Current words:', currentWords);
					currentQuestionIndex = 0;
					shuffleIndexes = generateShuffledRange(currentWords.length);
					console.log('Shuffle indexes:', shuffleIndexes);
					
					// Reset show/hide words button and hide words list when pack changes
					$('#show_words').text('Show');
					$('#cont_words').hide();
					
					loadQuestion();
				} else {
					// No packs selected, clear current data
					currentWords = [];
					currentPack = null;
					$('#question').text('');
					$('#answer').text('');
					$('#show_words').text('Show');
					$('#cont_words').hide();
				}
			});

			// Handle dictionary type change
			$('input[name="dic_type"]').change(function() {
				isSource2Target = $(this).val() === 'source2target';
				if (currentWords.length > 0) {
					loadQuestion();
				}
			});

			// Load a new question
			function loadQuestion() {
				console.log('loadQuestion called, currentWords.length:', currentWords.length);
				if (currentWords.length === 0) return;

				// Clear any existing highlights
				$('#choice_a, #choice_b, #choice_c').removeClass('correct-answer wrong-answer');

				// Get random word
				// const randomIndex = Math.floor(Math.random() * currentWords.length);
				const randomIndex = shuffleIndexes[currentQuestionIndex];
				currentQuestionIndex += 1;
				if (currentQuestionIndex >= shuffleIndexes.length) {
					// Regenerate the shuffle indexes when we have reached the end of the shuffle indexes
					shuffleIndexes = generateShuffledRange(currentWords.length);
					$('#cont_announcement').show();
					$('#cont_announcement').text('All items have been shown. We are shuffling again.');
					setTimeout(function() {
						$('#cont_announcement').hide();
					}, 3000);

				}
				currentQuestionIndex = currentQuestionIndex % shuffleIndexes.length;
				const word = currentWords[randomIndex];
				console.log('Selected word:', word);
				
				// Set question and answer based on direction
				if (isSource2Target) {
					$('#question').text(word.source);
					currentQuestion = word.source;
					correctAnswer = word.target;
				} else {
					$('#question').text(word.target);
					currentQuestion = word.target;
					correctAnswer = word.source;
				}

				// Handle answer type
				const answerType = $('input[name="answer_type"]:checked').val();
				
				if (answerType === 'text') {
					$('.answer_text').show();
					$('#answer_choice').hide();
					$('#user_answer').val('');
				} else {
					$('.answer_text').hide();
					$('#answer_choice').show();
					generateMultipleChoice();
				}
			}

			// Generate multiple choice options
			function generateMultipleChoice() {
				const options = [correctAnswer];
				
				// Add wrong answers - try to get up to 3 total options
				const maxOptions = Math.min(3, currentWords.length);
				let attempts = 0;
				const maxAttempts = 20; // Prevent infinite loop
				
				while (options.length < maxOptions && attempts < maxAttempts) {
					const randomWord = currentWords[Math.floor(Math.random() * currentWords.length)];
					const wrongAnswer = isSource2Target ? randomWord.target : randomWord.source;
					if (!options.includes(wrongAnswer)) {
						options.push(wrongAnswer);
					}
					attempts++;
				}

				// If we still don't have enough options, add generic wrong answers
				while (options.length < 3) {
					options.push('Wrong ' + options.length);
				}

				// Shuffle options
				options.sort(() => Math.random() - 0.5);

				$('#choice_a').text('').attr('title', '');
				$('#choice_b').text('').attr('title', '');
				$('#choice_c').text('').attr('title', '');
				
				setTimeout(function() {
					$('#choice_a').text(options[0]).attr('title', options[0]);
					$('#choice_b').text(options[1]).attr('title', options[1]);
					$('#choice_c').text(options[2]).attr('title', options[2]);

					$('.answer_choice.choice_a').val(options[0]);
					$('.answer_choice.choice_b').val(options[1]);
					$('.answer_choice.choice_c').val(options[2]);
				}, 1500);

				// Clear previous selection
				$('input[name="answer_choice"]').prop('checked', false);
			}

			// Show answer
			$('#show_answer').click(function(e) {
				e.preventDefault();
				$('#answer').text(correctAnswer);
			});

			// Check answer
			$('#check_answer').click(function(e) {
				e.preventDefault();
				console.log('Check Answer button clicked');
				checkUserAnswer();
			});

			// Use event delegation for dynamic content (jQuery 1.6.2 compatible)
			$('input[name="answer_choice"]').live('change', function() {
				console.log('Multiple choice option selected via live');
				// Add a small delay to let the user see their selection
				setTimeout(function() {
					checkUserAnswer();
				}, 100);
			});

			// Debug: Check if event handlers are attached
			console.log('Number of answer choice inputs found:', $('input[name="answer_choice"]').length);
			console.log('Number of user answer inputs found:', $('#user_answer').length);

			// Auto-check when user presses Enter in text input
			$('#user_answer').live('keypress', function(e) {
				if (e.which === 13) { // Enter key
					console.log('Enter pressed in text input');
					checkUserAnswer();
				}
			});

			// Function to check user answer and handle highlighting/statistics
			function checkUserAnswer() {
				const answerType = $('input[name="answer_type"]:checked').val();
				let userAnswer = '';
				console.log('checkUserAnswer called, answerType:', answerType);

				if (answerType === 'text') {
					userAnswer = $('#user_answer').val().trim();
				} else {
					const selectedChoice = $('input[name="answer_choice"]:checked');
					if (selectedChoice.length > 0) {
						const choiceText = selectedChoice.val();
						userAnswer = choiceText;
					}
				}

				if (userAnswer === '') {
					alert('Please provide an answer first.');
					return;
				}

				console.log('checkUserAnswer called, userAnswer:', userAnswer);
				// Update statistics
				totalQuestions++;
				const isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
				if (isCorrect) {
					correctAnswers++;
				}
				console.log('checkUserAnswer called, isCorrect:', isCorrect);
				
				// Track last 20 answers
				last20Answers.push(isCorrect ? '✓' : '✗');
				if (last20Answers.length > 20) {
					last20Answers.shift();
				}

				// Highlight correct answer
				highlightCorrectAnswer(isCorrect, userAnswer);

				// Show result
				var resetAnswerTimer = 2000;
				if (!isCorrect) {
					resetAnswerTimer = 5000;
				}
				$('#answer').text(currentQuestion + ' = ' + correctAnswer);
				setTimeout(function() {
					$('#answer').text('');
				}, resetAnswerTimer);

				console.log('checkUserAnswer called, auto-advance to next question after 2 seconds');
				// Auto-advance to next question after 2 seconds
				setTimeout(function() {
					loadQuestion();
				}, 2000);

				if (totalQuestions % 5 == 0) {
					updateStatisticsDisplay();
					$('#cont_stat').show();
					
					// Auto-hide statistics after 5 seconds
					setTimeout(function() {
						$('#cont_stat').hide();
					}, 5000);
				}
			}

			// Function to highlight the correct answer
			function highlightCorrectAnswer(isCorrect, userAnswer) {
				console.log('highlightCorrectAnswer called, isCorrect:', isCorrect);
				console.log('highlightCorrectAnswer called, userAnswer:', userAnswer);
				// Remove any existing highlights
				$('#choice_a, #choice_b, #choice_c').removeClass('correct-answer wrong-answer');
				
				// Find and highlight the correct answer
				$('#choice_a, #choice_b, #choice_c').each(function() {
					const choiceText = $(this).text();
					if (choiceText === correctAnswer) {
						$(this).addClass('correct-answer');
					} else if (choiceText === userAnswer && !isCorrect) {
						$(this).addClass('wrong-answer');
					}
				});
				console.log('highlightCorrectAnswer called, finished highlighting');
			}

			// Handle answer type change
			$('input[name="answer_type"]').change(function() {
				if (currentWords.length > 0) {
					loadQuestion();
				}
			});

			// Keyboard shortcuts for multiple choice
			$(document).keydown(function(e) {
				console.log('Key pressed:', e.which, e.keyCode, e.key);
				if ($('input[name="answer_type"]:checked').val() === 'option') {
					if (e.which === 49 || e.keyCode === 49) { // Key '1'
						console.log('Key 1 pressed');
						$('input.answer_choice.choice_a').prop('checked', true);
						// Trigger answer checking after selection
						setTimeout(function() {
							checkUserAnswer();
						}, 100);
					} else if (e.which === 50 || e.keyCode === 50) { // Key '2'
						console.log('Key 2 pressed');
						$('input.answer_choice.choice_b').prop('checked', true);
						// Trigger answer checking after selection
						setTimeout(function() {
							checkUserAnswer();
						}, 100);
					} else if (e.which === 51 || e.keyCode === 51) { // Key '3'
						console.log('Key 3 pressed');
						$('input.answer_choice.choice_c').prop('checked', true);
						// Trigger answer checking after selection
						setTimeout(function() {
							checkUserAnswer();
						}, 100);
					}
				}
			});

			// Update statistics display
			function updateStatisticsDisplay() {
				$('#q_cnt').text(totalQuestions);
				$('#form').text(last20Answers.join(''));
				const percentage = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
				$('#form2').text(percentage);
			}

			// Populate the words list
			function populateWordsList() {
				const wordsList = $('#words_list');
				wordsList.empty();
				
				if (currentWords && currentWords.length > 0) {
					currentWords.forEach(function(word) {
						const listItem = $('<li></li>');
						listItem.text(word.source + ' = ' + word.target);
						wordsList.append(listItem);
					});
				}
			}

			// Handle statistics link click
			$('#write_stat').click(function(e) {
				e.preventDefault();
				updateStatisticsDisplay();
				$('#cont_stat').show();
				
				// Auto-hide statistics after 5 seconds
				setTimeout(function() {
					$('#cont_stat').hide();
				}, 5000);
			});

			// Handle about link click
			$('#write_about').click(function(e) {
				e.preventDefault();
				$('#cont_about').show();
				
				// Auto-hide about after 5 seconds
				setTimeout(function() {
					$('#cont_about').hide();
				}, 5000);
			});

			// Handle show/hide words link click
			$('#show_words').click(function(e) {
				e.preventDefault();
				const wordsContainer = $('#cont_words');
				const showWordsLink = $('#show_words');
				
				if (wordsContainer.is(':visible')) {
					// Hide the words list
					wordsContainer.hide();
					showWordsLink.text('Show');
				} else {
					// Show the words list
					if (currentWords && currentWords.length > 0) {
						populateWordsList();
						wordsContainer.show();
						showWordsLink.text('Hide ' + currentWords.length + ' words');
					} else {
						alert('Please select a pack first.');
					}
				}
			});

			// Handle multiple choice help link click
			$('#write_mul_cho').click(function(e) {
				e.preventDefault();
				$('#cont_mul_cho').show();
				
				// Auto-hide multiple choice help after 5 seconds
				setTimeout(function() {
					$('#cont_mul_cho').hide();
				}, 5000);
			});

			// Initialize the game
			loadDataset();
		});
	</script>

</body>

</html>
